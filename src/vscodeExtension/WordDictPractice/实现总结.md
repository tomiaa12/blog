# VSCode 扩展 Google OAuth 登录实现总结

## ⚠️ 重要更新

**已修复架构问题！** 之前的实现尝试在浏览器环境创建 HTTP 服务器，这是不可行的。

**✅ 新架构**：
- HTTP 服务器在 VSCode 扩展（Node.js 环境）中创建
- VitePress 应用（浏览器环境）通过消息通信与扩展交互
- 详细说明请查看 [架构修复说明.md](./架构修复说明.md)

## 📝 改动概览

本次实现为 VSCode 扩展添加了完整的 Google OAuth 登录支持，允许用户在 VSCode 扩展环境下通过 Firebase 进行身份验证。

## 🔧 修改的文件

### 1. `src/hooks/useFirebaseAuth.ts`

**新增功能：**

- 导入 `signInWithCredential` 用于 OAuth 登录
- 新增接口 `VSCodeOAuthConfig` 定义 OAuth 配置
- 新增函数 `startLocalServerForCallback()` - 启动本地服务器接收授权回调
- 新增函数 `exchangeCodeForToken()` - 用授权码交换 access token
- 新增函数 `signInWithGoogleInVSCode()` - VSCode 环境的 Google OAuth 登录主函数
- 在 `useFirebaseAuth()` 返回值中暴露 `signInWithGoogleInVSCode`

**主要特性：**

- 自动启动本地 HTTP 服务器监听端口（默认 5589）
- 通过 `window.postMessage` 与 VSCode 扩展通信
- 完整的错误处理和超时机制（5分钟）
- 用户友好的回调页面提示

### 2. `src/vscodeExtension/WordDictPractice/extension.js`

**新增功能：**

- 添加 webview 消息监听器
- 处理 `vscode-open-external` 消息类型
- 调用 `vscode.env.openExternal()` 在外部浏览器打开 OAuth URL
- 添加 webview 与扩展之间的消息转发机制

**消息流：**

```
iframe 网页应用
  ↓ window.parent.postMessage()
webview HTML
  ↓ vscode.postMessage()
VSCode 扩展
  ↓ vscode.env.openExternal()
外部浏览器
```

### 3. `src/components/FirebaseLogin.vue`

**新增功能：**

- 导入 `isVSCode` 工具函数检测运行环境
- 导入 `signInWithGoogleInVSCode` 方法
- 在 `handleLogin()` 中根据环境选择登录方式：
  - VSCode 环境：使用 OAuth 流程
  - 浏览器环境：使用弹窗登录
- 添加环境变量验证
- 改进错误提示和用户反馈

**使用示例：**

```typescript
if (isInVSCode) {
  await signInWithGoogleInVSCode({
    clientId: import.meta.env.VITE_GOOGLE_CLIENT_ID,
    clientSecret: import.meta.env.VITE_GOOGLE_CLIENT_SECRET,
    redirectPort: 5589
  })
} else {
  await signInWithGoogle()
}
```

## 📚 新增文档

### 1. `VSCODE_OAUTH_GUIDE.md`

完整的使用指南，包括：
- 工作原理说明
- Google OAuth 配置步骤
- 环境变量配置
- 代码使用示例
- 消息通信机制
- 安全注意事项
- 故障排查指南
- 完整的 Vue 组件示例

### 2. `ENV_SETUP.md`

环境变量配置详细指南，包括：
- 必需的环境变量列表
- 从 Firebase Console 获取配置
- 从 Google Cloud Console 获取 OAuth 凭据
- 自定义端口配置
- 测试配置方法
- 生产环境最佳实践
- Secret Storage API 使用示例

### 3. 实现总结.md（本文档）

本文档，总结所有改动和实现细节。

## 🔐 环境变量要求

需要在项目根目录创建 `.env` 文件：

```env
# Firebase 配置
VITE_FIREBASE_API_KEY=your-firebase-api-key
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id

# Google OAuth 配置
VITE_GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
VITE_GOOGLE_CLIENT_SECRET=your-client-secret
VITE_GOOGLE_OAUTH_PORT=5589  # 可选
```

## 🌐 Google Cloud Console 配置

必须在 Google Cloud Console 中：

1. 启用 Google+ API 或 Google Identity
2. 创建 OAuth 2.0 客户端 ID（Web 应用类型）
3. 添加授权重定向 URI：`http://localhost:5589/callback`

## 🔄 工作流程

1. **用户点击登录** → 检测是否在 VSCode 环境
2. **构建 OAuth URL** → 包含 client_id、redirect_uri、scope 等参数
3. **启动本地服务器** → 监听端口 5589 等待回调
4. **打开授权页面** → 通过消息通信让 VSCode 打开外部浏览器
5. **用户授权** → Google 重定向到 `http://localhost:5589/callback?code=...`
6. **接收授权码** → 本地服务器捕获 code 参数
7. **交换 Token** → 用 code + client_secret 换取 access_token 和 id_token
8. **Firebase 登录** → 用 token 创建 credential 并登录
9. **更新用户资料** → 保存到 Firestore
10. **完成** → 显示用户信息

## 🛡️ 安全考虑

1. **客户端密钥保护**：
   - 使用环境变量，不要硬编码
   - 生产环境使用 VSCode Secret Storage
   - 考虑使用后端代理避免暴露密钥

2. **重定向 URI 限制**：
   - 只使用 localhost
   - 在 Google Console 中严格限制允许的 URI

3. **超时保护**：
   - 本地服务器 5 分钟后自动关闭
   - 防止端口一直被占用

4. **错误处理**：
   - 用户取消授权会收到友好提示
   - 网络错误、Token 交换失败都有相应处理

## 🧪 测试方法

1. **启动开发服务器**：
   ```bash
   pnpm dev
   ```

2. **在 VSCode 中打开扩展**：
   - 按 F5 启动扩展开发主机
   - 打开扩展侧边栏

3. **点击登录按钮**：
   - 应该在外部浏览器打开 Google 授权页
   - 授权后浏览器显示"登录成功"
   - VSCode 扩展显示用户信息

4. **检查控制台**：
   - 查看是否有错误日志
   - 确认本地服务器启动和关闭

## 📦 依赖关系

已有的依赖：
- `firebase/app` - Firebase 初始化
- `firebase/auth` - 身份验证（新增 `signInWithCredential`）
- `firebase/firestore` - 数据存储
- `vue` - 响应式框架
- `vscode` - VSCode 扩展 API

新引入的 Node.js 模块：
- `http` - 动态导入，仅在 Node.js 环境使用

## 🔮 未来优化建议

1. **Refresh Token 支持**：
   - 保存 refresh token 实现长期登录
   - 自动刷新 access token

2. **多端口尝试**：
   - 如果默认端口被占用，自动尝试其他端口

3. **更好的 UI 反馈**：
   - 显示"等待授权..."状态
   - 显示授权进度

4. **离线支持**：
   - 缓存用户凭据
   - 支持离线使用部分功能

5. **其他登录方式**：
   - 支持 GitHub、Microsoft 等其他 OAuth 提供商
   - 支持邮箱密码登录

## 📞 故障排查

### 问题：端口被占用

**解决方案**：
- 修改 `VITE_GOOGLE_OAUTH_PORT` 环境变量
- 在 Google Console 更新重定向 URI

### 问题：授权后没有反应

**检查**：
- 浏览器控制台是否有错误
- VSCode 开发者工具是否有错误
- 重定向 URI 是否匹配
- 防火墙是否阻止了本地服务器

### 问题：Token 交换失败

**检查**：
- Client ID 和 Secret 是否正确
- Google Cloud 项目是否与 Firebase 项目一致
- 是否启用了必要的 API

## ✅ 完成清单

- [x] 实现本地 OAuth 回调服务器
- [x] 实现 Token 交换逻辑
- [x] 实现 Firebase 登录集成
- [x] 添加 VSCode 扩展消息通信
- [x] 更新登录组件支持双环境
- [x] 编写完整的使用文档
- [x] 编写环境配置指南
- [x] 添加错误处理和超时机制
- [x] 添加用户友好的回调页面

## 📝 使用示例

最简单的使用方式：

```typescript
import { useFirebaseAuth } from '@/hooks/useFirebaseAuth'
import { isVSCode } from '@/utils/src/isVSCode'

const { signInWithGoogle, signInWithGoogleInVSCode } = useFirebaseAuth()

async function login() {
  if (isVSCode()) {
    await signInWithGoogleInVSCode({
      clientId: import.meta.env.VITE_GOOGLE_CLIENT_ID,
      clientSecret: import.meta.env.VITE_GOOGLE_CLIENT_SECRET,
    })
  } else {
    await signInWithGoogle()
  }
}
```

## 🎉 总结

本次实现完整支持了在 VSCode 扩展环境下使用 Google OAuth 登录，保持了与浏览器环境的一致性，并提供了详细的文档和错误处理。用户可以无缝地在不同环境下使用相同的登录功能。

