# âœ… ä¿®å¤åçš„æ¶æ„è¯´æ˜

## ğŸš¨ ä¹‹å‰çš„é—®é¢˜

### âŒ é”™è¯¯çš„å®ç°

```typescript
// useFirebaseAuth.ts (é”™è¯¯ç‰ˆæœ¬)
import("http")  // â† æµè§ˆå™¨ä¸­æ— æ³•ä½¿ç”¨ï¼
  .then(({ default: http }) => {
    const server = http.createServer(...)  // â† ä¼šå¤±è´¥ï¼
  })
```

**é—®é¢˜**ï¼š
- VitePress åº”ç”¨è¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒ
- å³ä½¿åœ¨ VSCode webview ä¸­ï¼Œä»ç„¶æ˜¯æµè§ˆå™¨ç¯å¢ƒ
- æµè§ˆå™¨æ— æ³•ä½¿ç”¨ Node.js çš„ `http` æ¨¡å—
- æ— æ³•åˆ›å»º HTTP æœåŠ¡å™¨

## âœ… æ­£ç¡®çš„å®ç°

### æ–°çš„æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VSCode æ‰©å±• (extension.js)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… Node.js ç¯å¢ƒ                                 â”‚ â”‚
â”‚ â”‚ âœ… å¯ä»¥ä½¿ç”¨ http æ¨¡å—                           â”‚ â”‚
â”‚ â”‚ âœ… åˆ›å»º HTTP æœåŠ¡å™¨ (localhost:5589)            â”‚ â”‚
â”‚ â”‚ âœ… å¤„ç† OAuth å›è°ƒ                              â”‚ â”‚
â”‚ â”‚ âœ… äº¤æ¢ access token                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• æ¶ˆæ¯é€šä¿¡ (postMessage)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webview HTML                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… è½¬å‘æ¶ˆæ¯                                     â”‚ â”‚
â”‚ â”‚   iframe â†” VSCode æ‰©å±•                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• postMessage
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ iframe ä¸­çš„ VitePress åº”ç”¨                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âŒ æµè§ˆå™¨ç¯å¢ƒ                                   â”‚ â”‚
â”‚ â”‚ âŒ ä¸èƒ½åˆ›å»ºæœåŠ¡å™¨                               â”‚ â”‚
â”‚ â”‚ âœ… åªè´Ÿè´£å‘é€ç™»å½•è¯·æ±‚                           â”‚ â”‚
â”‚ â”‚ âœ… æ¥æ”¶ç™»å½•ç»“æœ                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å®Œæ•´æµç¨‹

### ç¬¬ 1 æ­¥ï¼šç”¨æˆ·ç‚¹å‡»ç™»å½•

```typescript
// FirebaseLogin.vue
async function handleLogin() {
  if (isInVSCode) {
    await signInWithGoogleInVSCode({
      clientId: '...',
      clientSecret: '...'
    })
  }
}
```

### ç¬¬ 2 æ­¥ï¼šè¯·æ±‚å‘é€ç»™ VSCode æ‰©å±•

```typescript
// useFirebaseAuth.ts
function requestVSCodeOAuth(config) {
  // å‘é€æ¶ˆæ¯ç»™ VSCode æ‰©å±•
  window.parent.postMessage({
    type: 'vscode-oauth-login',
    config: {
      clientId: config.clientId,
      clientSecret: config.clientSecret,
      redirectPort: 5589
    }
  }, '*')
}
```

**æ¶ˆæ¯æµå‘**ï¼š
```
VitePress åº”ç”¨ (iframe)
  â†“ postMessage
Webview HTML
  â†“ vscode.postMessage()
VSCode æ‰©å±•
```

### ç¬¬ 3 æ­¥ï¼šVSCode æ‰©å±•å¤„ç†ç™»å½•

```javascript
// extension.js
webviewView.webview.onDidReceiveMessage(async message => {
  if (message.type === 'vscode-oauth-login') {
    // 1. å¯åŠ¨ HTTP æœåŠ¡å™¨
    const codePromise = this._startOAuthServer(5589)
    
    // 2. æ‰“å¼€æµè§ˆå™¨
    vscode.env.openExternal(vscode.Uri.parse(oauthURL))
    
    // 3. ç­‰å¾…æˆæƒç 
    const code = await codePromise
    
    // 4. äº¤æ¢ token
    const tokenData = await this._exchangeCodeForToken(code, config)
    
    // 5. è¿”å›ç»“æœ
    webviewView.webview.postMessage({
      type: 'vscode-oauth-success',
      data: tokenData
    })
  }
})
```

### ç¬¬ 4 æ­¥ï¼šåˆ›å»º HTTP æœåŠ¡å™¨ï¼ˆåœ¨æ‰©å±•ä¸­ï¼‰

```javascript
// extension.js - _startOAuthServer()
_startOAuthServer(port) {
  return new Promise((resolve, reject) => {
    // âœ… åœ¨ Node.js ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨ http æ¨¡å—
    const server = http.createServer((req, res) => {
      const url = new URL(req.url, `http://localhost:${port}`)
      if (url.pathname === '/callback') {
        const code = url.searchParams.get('code')
        res.end('ç™»å½•æˆåŠŸï¼')
        server.close()
        resolve(code)
      }
    })
    
    server.listen(port)  // â† æˆåŠŸï¼
  })
}
```

### ç¬¬ 5 æ­¥ï¼šæ‰“å¼€æµè§ˆå™¨æˆæƒ

```javascript
// VSCode API
vscode.env.openExternal(vscode.Uri.parse(
  'https://accounts.google.com/o/oauth2/v2/auth?...'
))
```

æµè§ˆå™¨æ‰“å¼€ â†’ ç”¨æˆ·æˆæƒ â†’ Google é‡å®šå‘åˆ° `http://localhost:5589/callback?code=xxx`

### ç¬¬ 6 æ­¥ï¼šæ¥æ”¶å›è°ƒ

```
æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5589/callback?code=xxx
           â†“
VSCode æ‰©å±•çš„ HTTP æœåŠ¡å™¨æ¥æ”¶
           â†“
æå– code å‚æ•°
           â†“
å…³é—­æœåŠ¡å™¨
```

### ç¬¬ 7 æ­¥ï¼šäº¤æ¢ Token

```javascript
// extension.js - _exchangeCodeForToken()
const resp = await fetch('https://oauth2.googleapis.com/token', {
  method: 'POST',
  body: new URLSearchParams({
    code,
    client_id,
    client_secret,
    redirect_uri,
    grant_type: 'authorization_code'
  })
})

const { access_token, id_token } = await resp.json()
```

### ç¬¬ 8 æ­¥ï¼šè¿”å›ç»“æœ

```javascript
// extension.js
webviewView.webview.postMessage({
  type: 'vscode-oauth-success',
  data: {
    access_token,
    id_token
  }
})
```

**æ¶ˆæ¯æµå‘**ï¼š
```
VSCode æ‰©å±•
  â†“ webview.postMessage()
Webview HTML
  â†“ iframe.contentWindow.postMessage()
VitePress åº”ç”¨ (iframe)
```

### ç¬¬ 9 æ­¥ï¼šä½¿ç”¨ Token ç™»å½• Firebase

```typescript
// useFirebaseAuth.ts
async function signInWithGoogleInVSCode(config) {
  // ç­‰å¾…æ‰©å±•è¿”å› token
  const { access_token, id_token } = await requestVSCodeOAuth(config)
  
  // ç”¨ token ç™»å½• Firebase
  const credential = GoogleAuthProvider.credential(id_token, access_token)
  const result = await signInWithCredential(auth, credential)
  
  return result
}
```

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### extension.js (Node.js ç¯å¢ƒ)

```javascript
// 1. å¼•å…¥ http æ¨¡å—
const http = require('http');

// 2. ç›‘å¬ç™»å½•è¯·æ±‚
webviewView.webview.onDidReceiveMessage(async message => {
  if (message.type === 'vscode-oauth-login') {
    // å¤„ç† OAuth ç™»å½•
  }
})

// 3. åˆ›å»º HTTP æœåŠ¡å™¨
_startOAuthServer(port) {
  const server = http.createServer(...)
  server.listen(port)
}

// 4. äº¤æ¢ token
_exchangeCodeForToken(code, config) {
  return fetch('https://oauth2.googleapis.com/token', ...)
}
```

### useFirebaseAuth.ts (æµè§ˆå™¨ç¯å¢ƒ)

```typescript
// 1. å‘é€è¯·æ±‚ç»™æ‰©å±•
function requestVSCodeOAuth(config) {
  window.parent.postMessage({
    type: 'vscode-oauth-login',
    config
  }, '*')
}

// 2. ä½¿ç”¨è¿”å›çš„ token ç™»å½•
async function signInWithGoogleInVSCode(config) {
  const { access_token, id_token } = await requestVSCodeOAuth(config)
  const credential = GoogleAuthProvider.credential(id_token, access_token)
  return await signInWithCredential(auth, credential)
}
```

## ğŸ“Š èŒè´£åˆ’åˆ†

| ç»„ä»¶ | ç¯å¢ƒ | èŒè´£ |
|------|------|------|
| **VitePress åº”ç”¨** | æµè§ˆå™¨ | å‘èµ·ç™»å½•è¯·æ±‚<br>æ¥æ”¶ç™»å½•ç»“æœ<br>ä½¿ç”¨ token ç™»å½• Firebase |
| **Webview HTML** | æµè§ˆå™¨ | è½¬å‘æ¶ˆæ¯ï¼ˆiframe â†” æ‰©å±•ï¼‰ |
| **VSCode æ‰©å±•** | Node.js | åˆ›å»º HTTP æœåŠ¡å™¨<br>æ‰“å¼€æµè§ˆå™¨<br>æ¥æ”¶ OAuth å›è°ƒ<br>äº¤æ¢ access token |
| **Google** | æœåŠ¡å™¨ | å¤„ç†ç”¨æˆ·æˆæƒ<br>ç”Ÿæˆæˆæƒç <br>äº¤æ¢ token |

## ğŸ¯ ç¯å¢ƒå¯¹æ¯”

### æµè§ˆå™¨ç¯å¢ƒï¼ˆVitePressï¼‰

```
âœ… å¯ä»¥åšï¼š
- å‘é€ HTTP è¯·æ±‚ (fetch)
- ä½¿ç”¨ postMessage é€šä¿¡
- ä½¿ç”¨ Firebase SDK
- æ“ä½œ DOM

âŒ ä¸èƒ½åšï¼š
- ä½¿ç”¨ Node.js æ¨¡å— (http, fs, etc)
- åˆ›å»º HTTP æœåŠ¡å™¨
- è®¿é—®æ–‡ä»¶ç³»ç»Ÿ
- æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
```

### Node.js ç¯å¢ƒï¼ˆVSCode æ‰©å±•ï¼‰

```
âœ… å¯ä»¥åšï¼š
- ä½¿ç”¨æ‰€æœ‰ Node.js æ¨¡å—
- åˆ›å»º HTTP æœåŠ¡å™¨
- è®¿é—®æ–‡ä»¶ç³»ç»Ÿ
- æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
- ä½¿ç”¨ VSCode API

âŒ ä¸èƒ½åšï¼š
- ç›´æ¥æ“ä½œ DOM
- ä½¿ç”¨æµè§ˆå™¨ API
```

## âœ… ä¿®å¤æ€»ç»“

**ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰**ï¼š
- âŒ åœ¨æµè§ˆå™¨ä¸­å°è¯•åˆ›å»º HTTP æœåŠ¡å™¨
- âŒ å¯¼å…¥ Node.js çš„ http æ¨¡å—ä¼šå¤±è´¥

**ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰**ï¼š
- âœ… åœ¨ VSCode æ‰©å±•ä¸­åˆ›å»º HTTP æœåŠ¡å™¨
- âœ… æµè§ˆå™¨é€šè¿‡æ¶ˆæ¯é€šä¿¡è¯·æ±‚æ‰©å±•
- âœ… æ‰©å±•å¤„ç†å®Œåè¿”å›ç»“æœ
- âœ… æµè§ˆå™¨ä½¿ç”¨ç»“æœç™»å½• Firebase

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. é…ç½® Google OAuth å‡­æ®
2. åˆ›å»º `.env.local` æ–‡ä»¶
3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š`pnpm dev`
4. åœ¨ VSCode ä¸­æŒ‰ F5 å¯åŠ¨æ‰©å±•è°ƒè¯•
5. ç‚¹å‡»ç™»å½•æŒ‰é’®
6. åº”è¯¥ä¼šï¼š
   - åœ¨å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€ Google æˆæƒé¡µ
   - æˆæƒåè·³è½¬åˆ° `http://localhost:5589/callback`
   - æ˜¾ç¤º"ç™»å½•æˆåŠŸ"
   - VSCode æ‰©å±•æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

## ğŸ‰ å®Œæˆ

ç°åœ¨å®ç°äº†æ­£ç¡®çš„æ¶æ„ï¼š
- âœ… VSCode æ‰©å±•åœ¨ Node.js ç¯å¢ƒè¿è¡Œï¼Œè´Ÿè´£åˆ›å»ºæœåŠ¡å™¨
- âœ… VitePress åº”ç”¨åœ¨æµè§ˆå™¨ç¯å¢ƒè¿è¡Œï¼Œè´Ÿè´£ UI å’Œ Firebase ç™»å½•
- âœ… é€šè¿‡æ¶ˆæ¯é€šä¿¡æ¡¥æ¥ä¸¤ä¸ªç¯å¢ƒ
- âœ… èŒè´£æ¸…æ™°ï¼Œæ¶æ„åˆç†

è¿™æ˜¯ VSCode æ‰©å±• webview ä¸ OAuth ç»“åˆçš„**æ ‡å‡†å®ç°æ¨¡å¼**ï¼

